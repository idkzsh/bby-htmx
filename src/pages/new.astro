---
import { d, smartsheets } from "../data/hierarchy";
import Layout from "../layouts/Layout.astro";
const isHTMXRequest = Astro.request.headers.get("HX-Request") === "true";

let selectedDept = 0;
---

{
  isHTMXRequest ? (
    <form
      action="/setup"
      class="border rounded-md flex flex-col p-4 gap-4 shadow-md font-normal text-base tracking-tight"
      id="new"
    >
      <label for="email">Email</label>
      <input name="email" id="email" type="email" autocomplete="email" class="border rounded-md p-1 w-80" />
      <label for="department">Product Type</label>
      <select
        name="department"
        id="department"
        class="border h-10 rounded-md px-2 overflow-hidden w-80"
      >
        {d.map((category, index) => (
          <option value={category.dept} title={category.value}>
                {category.value.length > 40
                  ? category.value.slice(0, 37) + "..."
                  : category.value}
          </option>
        ))}
      </select>
      <label for="subCategory" class="hidden">Sub Category</label>
      <select name="subCategory" id="subCategory" class="border h-10 rounded-md px-2 overflow-hidden w-80 hidden">
        <option value="">Select a sub-category</option>
  {smartsheets.map((category) => (
    category.value.map((item) => (
      <option value={item} data-dept={category.dept}>{item}</option>
    ))
  ))}
      </select>
      <label for="numOfSKUs"># of SKUs</label>
      <input name="numOfSKUs" id="numOfSKUs" type="number" class="border rounded-md p-1" />
      <button
        type="submit"
        form="new"
        class="w-80 hover:opacity-80 bg-black text-white rounded-md p-2"
      >
        Submit
      </button>
    </form>
  ) : (
    <Layout title="new">
      <main
        class="flex flex-col w-[89.5%] h-[98%] bg-white mt-2 rounded-md border justify-center items-center gap-8 font-bold tracking-tighter text-3xl"
        id="main"
      >
        <form
          action="/setup"
          class="border rounded-md flex flex-col p-4 gap-4 shadow-md font-normal text-base tracking-tight"
          id="new"
        >
          <label for="email">Email</label>
          <input name="email" id="email" type="email" autocomplete="email" class="border rounded-md p-1 w-80" />
          <label for="department">Product Type</label>
          <select
            name="department"
            id="department"
            class="border h-10 rounded-md px-2 w-80"
          >
            {d.map((category, index) => (
              <option value={category.dept} title={category.value}>
                {category.value.length > 40
                  ? category.value.slice(0, 37) + "..."
                  : category.value}
              </option>
            ))}
          </select>
          <label for="subCategory" class="hidden">Sub Category</label>
          <select name="subCategory" id="subCategory" class="border h-10 rounded-md px-2 overflow-hidden w-80 hidden">
        <option value="">Select a sub-category</option>
  {smartsheets.map((category) => (
    category.value.map((item) => (
      <option value={item} data-dept={category.dept}>{item}</option>
    ))
  ))}
      </select>
          <label for="numOfSKUs"># of SKUs</label>
          <input name="numOfSKUs" id="numOfSKUs" type="number" class="border rounded-md p-1" />
          <button
            type="submit"
            form="new"
            class="w-80 hover:opacity-80 bg-black text-white rounded-md p-2"
          >
            Submit
          </button>
        </form>
      </main>
    </Layout>
  )



}



<script>
  function initializeForm() {
    const deptSelect = document.getElementById("department");
    const subCategorySelect = document.getElementById("subCategory");
    
    if (deptSelect instanceof HTMLSelectElement && subCategorySelect instanceof HTMLSelectElement) {
      deptSelect.addEventListener("change", () => {
        const selectedDeptValue = Number(deptSelect.value);
        
        // Show/hide subCategory based on selection
        if (selectedDeptValue === 9) {
          subCategorySelect.classList.remove("hidden");
          subCategorySelect.previousElementSibling?.classList.remove("hidden");
        } else {
          subCategorySelect.classList.add("hidden");
          subCategorySelect.previousElementSibling?.classList.add("hidden");
        }
        
        // Filter and show only relevant options
        Array.from(subCategorySelect.options).forEach(option => {
          if (option instanceof HTMLOptionElement) {
            option.style.display = option.dataset.dept === String(selectedDeptValue) ? "" : "none";
          }
        });
        
        // Reset selection
        subCategorySelect.selectedIndex = 0;
      });
    }
  }

  // Function to initialize the form
  function setupForm() {
    initializeForm();
  }

  // For non-HTMX requests
  if (!document.body.hasAttribute("data-htmx-history-restore")) {
    document.addEventListener("DOMContentLoaded", setupForm);
  }

  // For HTMX requests
  document.body.addEventListener("htmx:load", (event: Event) => {
    // Type assertion for the custom event
    const htmxEvent = event as CustomEvent<{ elt: HTMLElement }>;
    if (htmxEvent.detail.elt.id === "new") {
      setupForm();
    }
  });
</script>