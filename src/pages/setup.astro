---
import Layout from "../layouts/Layout.astro";
import { inputs } from "../data/setup";

let columns = Number(Astro.url.searchParams.get("numOfSKUs") || 1);
let email = Astro.url.searchParams.get("email") || "";

if (columns > 50) {
  columns = 50;
}

let excelData;

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    await new Promise((resolve) => setTimeout(resolve, 1000));
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
      excelData = null;
    }
  }
}
---

<Layout title="Setup">
  <main
    class="flex w-[90%] h-[98%] bg-white mt-2 rounded-md border tracking-tight overflow-scroll"
    id="main"
  >
    <form action="/compliance" method="POST" id="setupForm" class="hidden">
      <!-- Hidden inputs will be dynamically added here -->
    </form>
    <div id="handsontable-container" class="w-full h-[400px]"></div>
    <!-- <form
        class="flex items-center justify-center gap-2 w-[600px]"
        id="uploadForm"
        name="uploadForm"
        method="POST"
        enctype="multipart/form-data"
      >
        Import Excel File: <input
          type="file"
          class="flex items-center justify-center pt-[2px] pl-[2px] w-60 rounded-md h-8"
          id="excelFileInput"
          name="excelFileInput"
          accept=".csv, .xlsx, .xlsb"
        />
        <input type="hidden" name="columns" value={columns} />
        <div class="relative w-24">
          <button class="btn text-xs" type="submit" @click="loading = true" :disabled="!fileSelected">Upload</button>
        </div>
      </form> -->

    <!-- <Sidebar obj={headers} />
      <SetupColumn
      obj={inputs}
      columns={columns}
      formName="setupForm"
      data={excelData}
    /> -->
  </main>
</Layout>

<script
  src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"
></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css"
/>

<script define:vars={{ columns, email, inputs }} type="module" defer>
  const requiredFields = inputs
    .filter((input) => input.required)
    .map((input) => input.name);

  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("handsontable-container");

    const headerNames = inputs.map((input) => input.name);
    const rows = inputs.length;

    const data = Array(rows)
      .fill()
      .map(() => Array(columns).fill(""));

    const hot = new Handsontable(container, {
      data: data,
      rowHeaders: headerNames,
      rowHeaderWidth: 250, // Adjust this value as needed
      afterGetRowHeader: function (row, TH) {
        // Force text wrapping for all row headers
        TH.style.whiteSpace = "normal";
        TH.style.overflow = "visible";
        TH.style.textAlign = "left";
      },
      colHeaders: Array(columns)
        .fill()
        .map((_, i) => `SKU ${i + 1}`),
      height: "100%",
      width: "100%",
      licenseKey: "non-commercial-and-evaluation",
      cells: function (row, col) {
        const cellProperties = {};
        const rowHeader = headerNames[row];
        const input = inputs.find((input) => input.name === rowHeader);
        if (input) {
          cellProperties.placeholder = input.placeholder || "";

          if (input.type === "select" && input.options) {
            cellProperties.type = "dropdown";
            cellProperties.source = Object.values(input.options);
          }

          switch (input.name) {
            case "Vendor Part Number":
              cellProperties.validator = function (value, callback) {
                callback(value.length <= 20);
              };
              break;
            case "SKU Title (Long)":
              cellProperties.validator = function (value, callback) {
                callback(value.length <= 40);
              };
              break;
            case "UPC":
            case "SECONDARY_UPC":
              cellProperties.validator = function (value, callback) {
                const numericValue = value.toString().replace(/\D/g, "");
                callback(
                  numericValue.length >= 12 && numericValue.length <= 13
                );
              };
              break;
          }

          if (input.type === "number") {
            cellProperties.type = "numeric";
            cellProperties.numericFormat = { pattern: "0" };

            cellProperties.validator = function (value, callback) {
              callback(
                typeof value === "number" &&
                  value >= input.min &&
                  value <= input.max
              );
            };

            cellProperties.renderer = function (
              instance,
              td,
              row,
              col,
              prop,
              value,
              cellProperties
            ) {
              Handsontable.renderers.NumericRenderer.apply(this, arguments);
              td.style.textAlign = "left";
            };
          }
          cellProperties.allowInvalid = false;

          if (input.type === "float") {
            cellProperties.type = "numeric";
            cellProperties.numericFormat = { pattern: "0,0.00" };
            cellProperties.allowInvalid = false;
            cellProperties.validator = function (value, callback) {
              callback(
                typeof value === "number" &&
                  value >= input.min &&
                  value <= input.max
              );
            };

            cellProperties.renderer = function (
              instance,
              td,
              row,
              col,
              prop,
              value,
              cellProperties
            ) {
              Handsontable.renderers.NumericRenderer.apply(this, arguments);
              td.style.textAlign = "left";
            };
          }
        }

        switch (rowHeader) {
          case "Vendor Part Number":
            cellProperties.validator = function (value, callback) {
              if (value.length <= 20) {
                callback(true);
              } else {
                callback(false);
              }
            };
            cellProperties.allowInvalid = false;
            break;
          case "SKU Title (Long)":
            cellProperties.validator = function (value, callback) {
              if (value.length <= 40) {
                callback(true);
              } else {
                callback(false);
              }
            };
            cellProperties.allowInvalid = false;
            break;
          case "UPC":
            cellProperties.validator = function (value, callback) {
              const numericValue = value.toString().replace(/\D/g, "");
              const isValid =
                numericValue.length >= 12 && numericValue.length <= 13;
              callback(isValid);
            };
            cellProperties.allowInvalid = false;
            break;
        }

        return cellProperties;
      },
      manualColumnResize: true,
      manualColumnResizeMinWidth: 100,
      manualColumnMove: true,
      stretchH: "all",
      // Set the width of the row header column

      // Allow row header resizing
      manualRowResize: true,
      // Prevent horizontal scrolling within cells
      wordWrap: true,
      // Optional: Adjust cell padding for better text visibility
      cellPadding: 5,
    });

    document.addEventListener("submit-handsontable", function () {
      const missingFields = [];

      // Check required fields
      for (let col = 0; col < columns; col++) {
        requiredFields.forEach((field) => {
          const rowIndex = headerNames.indexOf(field);
          if (rowIndex !== -1) {
            const cellValue = hot.getDataAtCell(rowIndex, col);
            if (!cellValue || cellValue === "") {
              missingFields.push(`${field} for SKU ${col + 1}`);
            }
          }
        });
      }

      if (missingFields.length > 0) {
        alert(
          `Please fill in the following required fields:\n${missingFields.join("\n")}`
        );
        return;
      }

      setupForm
        .querySelectorAll('input[type="hidden"]')
        .forEach((input) => input.remove());

      // Add hidden input for columns
      const columnsInput = document.createElement("input");
      columnsInput.type = "hidden";
      columnsInput.name = "columns";
      columnsInput.value = columns;
      setupForm.appendChild(columnsInput);

      const emailInput = document.createElement("input");
      emailInput.type = "hidden";
      emailInput.name = "email";
      emailInput.value = email;
      setupForm.appendChild(emailInput);

      // Add hidden inputs with Handsontable data
      const tableData = hot.getData();
      headerNames.forEach((header, rowIndex) => {
        const rowData = tableData[rowIndex];
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = header;
        input.value = JSON.stringify(rowData);
        setupForm.appendChild(input);
      });

      // Submit the form
      setupForm.submit();
    });
  });
</script>

<style>
  /* Optional: Add custom styles to improve header visibility */
  .handsontable th {
    white-space: normal;
    overflow-wrap: break-word;
  }
</style>
